<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="800" viewBox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg">
  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#2c3e50">
    Figure 2.2 : Diagramme de Séquence - Authentification et Connexion Utilisateur
  </text>
  
  <!-- Actors/Objects -->
  <g id="actors">
    <!-- User -->
    <rect x="50" y="80" width="80" height="40" fill="#3498db" stroke="#2980b9" stroke-width="2" rx="5"/>
    <text x="90" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Utilisateur</text>
    <line x1="90" y1="120" x2="90" y2="750" stroke="#2980b9" stroke-width="2" stroke-dasharray="5,5"/>
    
    <!-- Frontend -->
    <rect x="200" y="80" width="80" height="40" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="5"/>
    <text x="240" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Frontend React</text>
    <line x1="240" y1="120" x2="240" y2="750" stroke="#c0392b" stroke-width="2" stroke-dasharray="5,5"/>
    
    <!-- API Controller -->
    <rect x="350" y="80" width="80" height="40" fill="#f39c12" stroke="#e67e22" stroke-width="2" rx="5"/>
    <text x="390" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">API Controller</text>
    <line x1="390" y1="120" x2="390" y2="750" stroke="#e67e22" stroke-width="2" stroke-dasharray="5,5"/>
    
    <!-- JWT Service -->
    <rect x="500" y="80" width="80" height="40" fill="#9b59b6" stroke="#8e44ad" stroke-width="2" rx="5"/>
    <text x="540" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">JWT Service</text>
    <line x1="540" y1="120" x2="540" y2="750" stroke="#8e44ad" stroke-width="2" stroke-dasharray="5,5"/>
    
    <!-- Database -->
    <rect x="650" y="80" width="80" height="40" fill="#2ecc71" stroke="#27ae60" stroke-width="2" rx="5"/>
    <text x="690" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Base MySQL</text>
    <line x1="690" y1="120" x2="690" y2="750" stroke="#27ae60" stroke-width="2" stroke-dasharray="5,5"/>
    
    <!-- Email Service -->
    <rect x="800" y="80" width="80" height="40" fill="#e91e63" stroke="#ad1457" stroke-width="2" rx="5"/>
    <text x="840" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Nodemailer</text>
    <line x1="840" y1="120" x2="840" y2="750" stroke="#ad1457" stroke-width="2" stroke-dasharray="5,5"/>
  </g>
  
  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2c3e50"/>
    </marker>
  </defs>
  
  <!-- Sequence Steps -->
  <g id="sequence">
    <!-- 1. User submits login -->
    <line x1="90" y1="160" x2="240" y2="160" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="165" y="155" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">1. Saisie email/mot de passe</text>
    
    <!-- 2. Frontend validates -->
    <rect x="220" y="180" width="40" height="15" fill="#ecf0f1" stroke="#bdc3c7"/>
    <text x="240" y="192" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#2c3e50">Validation</text>
    
    <!-- 3. API call -->
    <line x1="240" y1="210" x2="390" y2="210" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="315" y="205" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">2. POST /api/auth/login</text>
    
    <!-- 4. Check user exists -->
    <line x1="390" y1="230" x2="690" y2="230" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="540" y="225" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">3. SELECT * FROM utilisateurs</text>
    
    <!-- 5. User found -->
    <line x1="690" y1="250" x2="390" y2="250" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
    <text x="540" y="245" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">4. Données utilisateur</text>
    
    <!-- 6. Verify password -->
    <rect x="370" y="270" width="40" height="15" fill="#ecf0f1" stroke="#bdc3c7"/>
    <text x="390" y="282" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#2c3e50">bcrypt.compare()</text>
    
    <!-- 7. Generate JWT -->
    <line x1="390" y1="300" x2="540" y2="300" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="465" y="295" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">5. Générer token JWT</text>
    
    <!-- 8. JWT returned -->
    <line x1="540" y1="320" x2="390" y2="320" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
    <text x="465" y="315" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">6. Token signé</text>
    
    <!-- 9. Log connection -->
    <line x1="390" y1="340" x2="690" y2="340" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="540" y="335" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">7. INSERT historique_actions</text>
    
    <!-- 10. Success response -->
    <line x1="390" y1="360" x2="240" y2="360" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
    <text x="315" y="355" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">8. {token, user, success}</text>
    
    <!-- 11. Store token -->
    <rect x="220" y="380" width="40" height="15" fill="#ecf0f1" stroke="#bdc3c7"/>
    <text x="240" y="392" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#2c3e50">localStorage</text>
    
    <!-- 12. Redirect user -->
    <line x1="240" y1="410" x2="90" y2="410" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
    <text x="165" y="405" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">9. Redirection tableau de bord</text>
    
    <!-- Alternative flow: Email verification needed -->
    <rect x="50" y="450" width="800" height="120" fill="none" stroke="#95a5a6" stroke-width="1" rx="5"/>
    <text x="70" y="470" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#95a5a6">Alt [Email non vérifié]</text>
    
    <!-- Email verification flow -->
    <line x1="390" y1="490" x2="840" y2="490" stroke="#e91e63" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="615" y="485" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#e91e63">10. Envoyer email vérification</text>
    
    <line x1="840" y1="510" x2="390" y2="510" stroke="#e91e63" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
    <text x="615" y="505" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#e91e63">11. Email envoyé</text>
    
    <line x1="390" y1="530" x2="240" y2="530" stroke="#e91e63" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
    <text x="315" y="525" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#e91e63">12. Message vérification requise</text>
    
    <line x1="240" y1="550" x2="90" y2="550" stroke="#e91e63" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
    <text x="165" y="545" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#e91e63">13. Afficher message</text>
  </g>
  
</svg> 